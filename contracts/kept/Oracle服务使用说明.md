# 跨链Oracle服务使用说明

## 📋 概述

跨链Oracle服务是基于DID和可验证凭证的跨链协调服务，负责监控多链事件、生成跨链证明、颁发可验证凭证，并协调跨链资产转移。

## 🏗️ 系统架构

```
┌─────────────┐    ┌─────────────┐
│   Besu链A   │    │   Besu链B   │
│             │    │             │
│ 跨链桥合约  │    │ 跨链桥合约  │
│ DID验证器   │    │ DID验证器   │
└──────┬──────┘    └──────┬──────┘
       │                  │
       └──────────────────┼──────────────────┘
                          │
          ┌───────────────┼───────────────┐
          │     跨链Oracle服务            │
          │  ┌─────────────────────────┐  │
          │  │     VC颁发服务          │  │
          │  └─────────────────────────┘  │
          └───────────────┬───────────────┘
                          │
          ┌───────────────┴───────────────┐
          │       共享身份层              │
          │   VON Network (Indy链)        │
          │   ACA-Py代理集群              │
          └───────────────────────────────┘
```

## 🚀 快速开始

### 1. 环境准备

确保以下服务正在运行：
- Besu链A (端口8545)
- Besu链B (端口8555)
- VON Network (Indy链)
- ACA-Py服务 (端口8001)

### 2. 安装依赖

```bash
pip3 install web3 requests asyncio
```

### 3. 配置服务

编辑 `oracle_config.json` 配置文件：

```json
{
  "oracle": {
    "admin_url": "http://localhost:8001",
    "oracle_did": "did:indy:testnet:oracle#key-1",
    "oracle_address": "0x19E7E376E7C213B7E7e7e46cc70A5dD086DAff2A",
    "oracle_private_key": "0x1111111111111111111111111111111111111111111111111111111111111111"
  },
  "chains": [
    {
      "name": "Besu Chain A",
      "rpc_url": "http://localhost:8545",
      "chain_id": "chain_a",
      "bridge_address": "0x79eafd0b5ec8d3f945e6bb2817ed90b046c0d0af",
      "verifier_address": "0x73b647cba2fe75ba05b8e12ef8f8d6327d6367bf"
    },
    {
      "name": "Besu Chain B",
      "rpc_url": "http://localhost:8555",
      "chain_id": "chain_b",
      "bridge_address": "0x79eafd0b5ec8d3f945e6bb2817ed90b046c0d0af",
      "verifier_address": "0x73b647cba2fe75ba05b8e12ef8f8d6327d6367bf"
    }
  ]
}
```

### 4. 启动服务

#### 方式一：使用启动脚本（推荐）

```bash
# 启动标准版Oracle服务
./start_oracle.sh

# 启动增强版Oracle服务
./start_oracle.sh enhanced
```

#### 方式二：直接运行Python脚本

```bash
# 标准版
python3 cross_chain_oracle.py

# 增强版
python3 enhanced_oracle.py
```

### 5. 测试服务

```bash
python3 test_oracle.py
```

## 🔧 功能特性

### 核心功能

1. **多链事件监控**
   - 实时监控各Besu链的跨链事件
   - 支持AssetLocked和AssetUnlocked事件
   - 自动处理新区块中的事件

2. **跨链证明生成**
   - 根据锁定事件生成跨链证明
   - 记录源链和目标链信息
   - 防止重放攻击

3. **可验证凭证颁发**
   - 通过ACA-Py颁发跨链VC
   - 支持DID身份验证
   - 自动管理用户连接

4. **目标链证明记录**
   - 在目标链上记录跨链证明
   - 支持多链协调
   - 确保跨链操作的可验证性

### 高级功能

1. **健康检查**
   - 定期检查链连接状态
   - 监控ACA-Py服务状态
   - 自动重连机制

2. **事件队列处理**
   - 异步事件处理
   - 支持高并发操作
   - 错误重试机制

3. **连接管理**
   - 自动创建DID连接
   - 管理用户连接状态
   - 支持多用户并发

## 📊 监控和日志

### 日志文件

- `oracle.log` - 标准版Oracle服务日志
- `enhanced_oracle.log` - 增强版Oracle服务日志

### 日志级别

- `INFO` - 一般信息
- `WARNING` - 警告信息
- `ERROR` - 错误信息

### 监控指标

- 链连接状态
- ACA-Py连接状态
- 事件处理数量
- 错误率统计

## 🔒 安全考虑

### 安全措施

1. **私钥管理**
   - 使用环境变量存储私钥
   - 避免硬编码敏感信息
   - 定期轮换密钥

2. **访问控制**
   - 限制Oracle服务权限
   - 验证DID身份
   - 防止未授权访问

3. **防重放攻击**
   - 使用交易哈希作为唯一标识
   - 设置证明有效期
   - 记录已使用的证明

### 最佳实践

1. **网络隔离**
   - 使用专用网络
   - 配置防火墙规则
   - 监控网络流量

2. **备份和恢复**
   - 定期备份配置
   - 保存重要日志
   - 制定恢复计划

3. **监控和告警**
   - 设置关键指标监控
   - 配置异常告警
   - 定期安全审计

## 🛠️ 故障排除

### 常见问题

1. **链连接失败**
   - 检查Besu链是否运行
   - 验证RPC URL配置
   - 检查网络连接

2. **ACA-Py连接失败**
   - 确认ACA-Py服务状态
   - 检查端口配置
   - 验证API权限

3. **合约调用失败**
   - 检查合约地址
   - 验证ABI文件
   - 确认gas设置

4. **事件监控异常**
   - 检查区块同步状态
   - 验证事件过滤器
   - 查看错误日志

### 调试方法

1. **启用详细日志**
   ```python
   logging.basicConfig(level=logging.DEBUG)
   ```

2. **检查服务状态**
   ```python
   oracle = CrossChainOracle()
   status = oracle.get_status()
   print(json.dumps(status, indent=2))
   ```

3. **测试单个功能**
   ```bash
   python3 test_oracle.py
   ```

## 📈 性能优化

### 优化建议

1. **调整监控间隔**
   - 根据链活动调整检查频率
   - 平衡响应速度和资源使用

2. **优化事件处理**
   - 使用批量处理
   - 实现事件去重
   - 异步处理机制

3. **资源管理**
   - 监控内存使用
   - 优化数据库查询
   - 定期清理日志

## 🔄 更新和维护

### 版本更新

1. 备份当前配置
2. 停止Oracle服务
3. 更新代码和依赖
4. 验证配置兼容性
5. 重启服务

### 定期维护

1. **日志清理**
   - 定期清理旧日志文件
   - 压缩历史日志
   - 监控磁盘空间

2. **配置检查**
   - 验证配置文件
   - 检查合约地址
   - 更新连接信息

3. **性能监控**
   - 分析性能指标
   - 优化瓶颈
   - 调整参数

## 📞 支持和联系

如有问题或建议，请：

1. 查看日志文件
2. 运行测试脚本
3. 检查配置文件
4. 参考故障排除指南

---

**注意**: 本服务是跨链系统的核心组件，请确保在生产环境中进行充分测试和验证。
