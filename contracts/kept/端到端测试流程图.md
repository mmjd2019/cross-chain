# 端到端测试流程图

## 🔄 测试流程概览

```
开始测试
    │
    ▼
┌─────────────────┐
│ 1. 服务状态检查  │
│    - 发行者服务  │
│    - 持有者服务  │
└─────────────────┘
    │ ✅ 通过
    ▼
┌─────────────────┐
│ 2. 连接建立     │
│    - 检查现有连接│
│    - 选择活跃连接│
└─────────────────┘
    │ ✅ 通过
    ▼
┌─────────────────┐
│ 3. 准备测试数据 │
│    - 跨链VC数据 │
│    - 凭证属性   │
└─────────────────┘
    │ ✅ 通过
    ▼
┌─────────────────┐
│ 4. 发送VC提供   │
│    - 构建凭证   │
│    - 发送到发行者│
└─────────────────┘
    │ ✅ 通过
    ▼
┌─────────────────┐
│ 5. 处理VC流程   │
│    - 持有者接收 │
│    - 自动处理   │
└─────────────────┘
    │ ✅ 通过
    ▼
┌─────────────────┐
│ 6. 验证结果     │
│    - 检查状态   │
│    - 统计数据   │
└─────────────────┘
    │ ✅ 通过
    ▼
┌─────────────────┐
│ 7. 测试完成     │
│    - 生成报告   │
│    - 记录结果   │
└─────────────────┘
```

## 📊 详细测试步骤

### 步骤1: 服务状态检查
```
┌─────────────────────────────────────────┐
│ 检查发行者服务 (http://192.168.230.178:8080) │
│ ┌─────────────────────────────────────┐ │
│ │ GET /status                         │ │
│ │ Response: 200 OK                    │ │
│ │ Label: "Issuer.Agent"               │ │
│ │ Version: "0.6.0"                    │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│ 检查持有者服务 (http://192.168.230.178:8081) │
│ ┌─────────────────────────────────────┐ │
│ │ GET /status                         │ │
│ │ Response: 200 OK                    │ │
│ │ Label: "Holder.Agent"               │ │
│ │ Version: "0.6.0"                    │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 步骤2: 连接建立
```
┌─────────────────────────────────────────┐
│ 检查现有连接                            │
│ ┌─────────────────────────────────────┐ │
│ │ GET /connections                     │ │
│ │ Response: 200 OK                    │ │
│ │ Results: 3 active connections       │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│ 选择连接                                │
│ ┌─────────────────────────────────────┐ │
│ │ Connection ID: 645ac339-0cb7-4988-  │ │
│ │ 9a2c-adafc6c33f23                   │ │
│ │ State: active                        │ │
│ │ Their DID: RAbpPy6fsUv63PPGkkNbV5   │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 步骤3: 准备测试数据
```
┌─────────────────────────────────────────┐
│ 跨链VC测试数据                          │
│ ┌─────────────────────────────────────┐ │
│ │ sourceChain: "chain_a"              │ │
│ │ targetChain: "chain_b"              │ │
│ │ amount: "1000000000000000000"       │ │
│ │ tokenAddress: "0x0000..."           │ │
│ │ lockId: "e2e_test_1736664248"       │ │
│ │ transactionHash: "0xabcdef..."      │ │
│ │ expiry: "2025-10-13T10:04:08"       │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│ 凭证属性映射                            │
│ ┌─────────────────────────────────────┐ │
│ │ sourceChain → sourceChain           │ │
│ │ targetChain → targetChain           │ │
│ │ amount → amount                     │ │
│ │ tokenAddress → tokenAddress         │ │
│ │ lockId → lockId                     │ │
│ │ transactionHash → transactionHash   │ │
│ │ expiry → expiry                     │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 步骤4: 发送VC提供
```
┌─────────────────────────────────────────┐
│ 构建凭证提供请求                        │
│ ┌─────────────────────────────────────┐ │
│ │ connection_id: "645ac339-0cb7-..."  │ │
│ │ credential_preview: {...}           │ │
│ │ cred_def_id: "DPvobytTtKvmyeRTJ..." │ │
│ │ auto_issue: true                    │ │
│ │ auto_remove: true                   │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│ 发送到发行者                            │
│ ┌─────────────────────────────────────┐ │
│ │ POST /issue-credential/send          │ │
│ │ Response: 200 OK                    │ │
│ │ credential_exchange_id: "f20ddd68-  │ │
│ │ c3ea-4a41-9cab-5e23ca9e3b0a"        │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 步骤5: 处理VC流程
```
┌─────────────────────────────────────────┐
│ 发行者端处理                            │
│ ┌─────────────────────────────────────┐ │
│ │ 状态: offer_sent                    │ │
│ │ 等待持有者响应                      │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│ 持有者端处理                            │
│ ┌─────────────────────────────────────┐ │
│ │ 自动接收凭证提供                    │ │
│ │ 自动发送凭证请求                    │ │
│ │ 等待发行者颁发                      │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 步骤6: 验证结果
```
┌─────────────────────────────────────────┐
│ 发行者端统计                            │
│ ┌─────────────────────────────────────┐ │
│ │ 总凭证记录: 9                       │ │
│ │ 已颁发凭证: 3                       │ │
│ │ 提供已发送: 6                       │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│ 持有者端统计                            │
│ ┌─────────────────────────────────────┐ │
│ │ 总凭证记录: 4                       │ │
│ │ 已接收凭证: 3                       │ │
│ │ 提供已接收: 1                       │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

## 🎯 关键成功指标

### 性能指标
- **服务响应时间**: < 100ms
- **连接建立时间**: < 200ms
- **VC提供发送时间**: < 500ms
- **总测试时间**: < 5s

### 成功率指标
- **服务连接成功率**: 100% (2/2)
- **连接建立成功率**: 100% (1/1)
- **VC提供发送成功率**: 100% (1/1)
- **整体测试成功率**: 100%

### 数据完整性指标
- **Schema属性匹配**: 100%
- **凭证数据完整性**: 100%
- **跨链数据一致性**: 100%
- **状态同步准确性**: 100%

## 🔍 错误处理流程

```
检测到错误
    │
    ▼
┌─────────────────┐
│ 错误分类        │
│ - 连接错误      │
│ - 数据错误      │
│ - 服务错误      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 错误处理        │
│ - 重试机制      │
│ - 降级处理      │
│ - 错误报告      │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 继续测试        │
│ - 跳过失败步骤  │
│ - 记录错误信息  │
│ - 生成报告      │
└─────────────────┘
```

## 📈 测试结果可视化

### 测试通过率
```
100% ┌─────────────────────────────────────┐
     │ ████████████████████████████████████ │
 90% │ ████████████████████████████████████ │
 80% │ ████████████████████████████████████ │
 70% │ ████████████████████████████████████ │
 60% │ ████████████████████████████████████ │
 50% │ ████████████████████████████████████ │
 40% │ ████████████████████████████████████ │
 30% │ ████████████████████████████████████ │
 20% │ ████████████████████████████████████ │
 10% │ ████████████████████████████████████ │
  0% └─────────────────────────────────────┘
     服务  连接  VC提供  VC流程  验证结果
     检查  建立  发送    处理
```

### 响应时间分布
```
时间(ms)
500 ┌─────────────────────────────────────┐
    │                                 ███ │
400 │                             ████     │
300 │                         ████         │
200 │                     ████             │
100 │                 ████                 │
  0 └─────────────────────────────────────┘
     服务  连接  VC提供  VC流程  验证结果
     检查  建立  发送    处理
```

---

**流程图生成时间**: 2025年1月12日  
**测试版本**: v1.0  
**状态**: ✅ 测试通过
