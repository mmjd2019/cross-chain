# 跨链合约交互流程图

## 🔄 完整跨链交易流程

### 1. 用户身份验证流程

```mermaid
flowchart TD
    A[用户发起操作] --> B{是否已验证?}
    B -->|否| C[调用DID验证器]
    B -->|是| D[继续操作]
    C --> E[查询VON Network]
    E --> F{验证结果}
    F -->|成功| G[记录验证状态]
    F -->|失败| H[拒绝操作]
    G --> D
    H --> I[返回错误]
    D --> J[执行后续操作]
```

### 2. 跨链资产转移详细流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant AM as 资产管理器
    participant DID as DID验证器
    participant SB as 简化桥
    participant CB as 增强桥
    participant O as Oracle服务
    participant TC as 目标链
    participant TAM as 目标链资产管理器
    
    Note over U,TAM: 跨链资产转移流程
    
    U->>AM: 1. 发起跨链转移请求
    AM->>DID: 2. 验证用户身份
    DID-->>AM: 3. 返回验证结果
    
    alt 验证成功
        AM->>SB: 4a. 使用简化桥锁定资产
        SB->>SB: 5a. 记录锁定事件
        SB-->>AM: 6a. 返回锁定结果
    else 需要高级功能
        AM->>CB: 4b. 使用增强桥锁定资产
        CB->>CB: 5b. 记录锁定事件和统计
        CB-->>AM: 6b. 返回锁定结果
    end
    
    AM->>O: 7. 发送跨链证明到Oracle
    O->>TC: 8. 验证并转发到目标链
    TC->>TAM: 9. 在目标链解锁资产
    TAM-->>TC: 10. 返回解锁结果
    TC-->>O: 11. 返回跨链完成状态
    O-->>AM: 12. 确认跨链完成
    AM-->>U: 13. 通知用户完成
```

### 3. 合约状态管理流程

```mermaid
stateDiagram-v2
    [*] --> 未验证: 用户注册
    未验证 --> 验证中: 发起验证
    验证中 --> 已验证: 验证成功
    验证中 --> 验证失败: 验证失败
    验证失败 --> 未验证: 重新验证
    已验证 --> 操作中: 发起操作
    操作中 --> 已验证: 操作完成
    已验证 --> 锁定中: 发起跨链转移
    锁定中 --> 转移中: 资产锁定成功
    转移中 --> 解锁中: Oracle确认
    解锁中 --> 已完成: 目标链解锁成功
    已完成 --> 已验证: 转移完成
    锁定中 --> 已验证: 转移失败
    转移中 --> 已验证: 转移失败
    解锁中 --> 已验证: 转移失败
```

## 🔧 合约接口调用关系

### 1. DID验证器接口调用

```mermaid
graph LR
    A[用户操作] --> B[资产管理器]
    A --> C[简化桥]
    A --> D[增强桥]
    
    B --> E[DID验证器]
    C --> E
    D --> E
    
    E --> F[isUserVerified]
    E --> G[recordCrossChainProof]
    E --> H[verifyCrossChainProof]
```

### 2. 桥合约接口调用

```mermaid
graph LR
    A[资产管理器] --> B[简化桥]
    A --> C[增强桥]
    
    B --> D[lockAsset]
    B --> E[unlockAsset]
    B --> F[setVerifier]
    
    C --> G[lockAsset]
    C --> H[unlockAsset]
    C --> I[getBridgeStats]
    C --> J[setBridgeOperator]
```

### 3. 资产管理器接口调用

```mermaid
graph LR
    A[用户] --> B[资产管理器]
    
    B --> C[deposit]
    B --> D[withdraw]
    B --> E[transfer]
    B --> F[getBalance]
    B --> G[getContractInfo]
```

## 🏗️ 系统部署架构

### 1. 单链部署架构

```mermaid
graph TB
    subgraph "Besu Chain A"
        subgraph "核心层"
            DID[CrossChainDIDVerifier<br/>0x73b647cba2fe75ba05b8e12ef8f8d6327d6367bf]
        end
        
        subgraph "桥接层"
            SB[SimpleBridge<br/>0x6e05f58eedda592f34dd9105b1827f252c509de0]
            CB[CrossChainBridgeSimple<br/>0x79eafd0b5ec8d3f945e6bb2817ed90b046c0d0af]
        end
        
        subgraph "应用层"
            AM[SimpleAssetManager<br/>0xed8d61f42dc1e56ae992d333a4992c3796b22a74]
        end
        
        DID --> SB
        DID --> CB
        DID --> AM
        SB --> AM
        CB --> AM
    end
```

### 2. 跨链部署架构

```mermaid
graph TB
    subgraph "Besu Chain A"
        DID_A[CrossChainDIDVerifier]
        SB_A[SimpleBridge]
        CB_A[CrossChainBridgeSimple]
        AM_A[SimpleAssetManager]
        
        DID_A --> SB_A
        DID_A --> CB_A
        DID_A --> AM_A
        SB_A --> AM_A
        CB_A --> AM_A
    end
    
    subgraph "Besu Chain B"
        DID_B[CrossChainDIDVerifier]
        SB_B[SimpleBridge]
        CB_B[CrossChainBridgeSimple]
        AM_B[SimpleAssetManager]
        
        DID_B --> SB_B
        DID_B --> CB_B
        DID_B --> AM_B
        SB_B --> AM_B
        CB_B --> AM_B
    end
    
    subgraph "外部服务"
        VON[VON Network<br/>DID服务]
        ORACLE[Oracle服务<br/>跨链协调]
    end
    
    DID_A -.-> VON
    DID_B -.-> VON
    SB_A -.-> ORACLE
    SB_B -.-> ORACLE
    CB_A -.-> ORACLE
    CB_B -.-> ORACLE
```

## 📊 合约功能矩阵

| 功能 | DID验证器 | 简化桥 | 增强桥 | 资产管理器 |
|------|-----------|--------|--------|------------|
| **身份验证** | ✅ 核心功能 | ❌ | ❌ | ❌ |
| **跨链锁定** | ❌ | ✅ 基础功能 | ✅ 增强功能 | ❌ |
| **跨链解锁** | ❌ | ✅ 基础功能 | ✅ 增强功能 | ❌ |
| **资产管理** | ❌ | ❌ | ❌ | ✅ 核心功能 |
| **统计跟踪** | ❌ | ❌ | ✅ 核心功能 | ❌ |
| **权限管理** | ✅ 高级功能 | ✅ 基础功能 | ✅ 高级功能 | ✅ 基础功能 |
| **事件记录** | ✅ 验证事件 | ✅ 桥事件 | ✅ 增强事件 | ✅ 资产事件 |

## 🔐 安全控制流程

### 1. 权限验证流程

```mermaid
flowchart TD
    A[用户操作] --> B{检查调用者权限}
    B -->|无权限| C[拒绝操作]
    B -->|有权限| D{检查DID验证状态}
    D -->|未验证| E[要求身份验证]
    D -->|已验证| F{检查操作权限}
    F -->|无操作权限| G[拒绝操作]
    F -->|有操作权限| H[执行操作]
    E --> I[调用DID验证器]
    I --> J{验证结果}
    J -->|成功| F
    J -->|失败| C
```

### 2. 跨链安全验证

```mermaid
flowchart TD
    A[跨链请求] --> B{验证源链证明}
    B -->|无效| C[拒绝请求]
    B -->|有效| D{检查时间戳}
    D -->|过期| E[拒绝请求]
    D -->|有效| F{检查重放攻击}
    F -->|已处理| G[拒绝请求]
    F -->|未处理| H[执行跨链操作]
    H --> I[记录处理状态]
    I --> J[返回结果]
```

## 🎯 最佳实践建议

### 1. 合约调用顺序
1. **身份验证**: 首先验证用户身份
2. **权限检查**: 检查操作权限
3. **业务逻辑**: 执行具体业务操作
4. **状态更新**: 更新相关状态
5. **事件记录**: 记录操作事件

### 2. 错误处理
- 使用require进行输入验证
- 使用revert返回详细错误信息
- 记录所有异常情况
- 提供用户友好的错误消息

### 3. 事件设计
- 记录所有关键操作
- 包含足够的上下文信息
- 便于监控和审计
- 支持链下数据分析

### 4. 升级策略
- 保持接口兼容性
- 使用代理模式
- 渐进式升级
- 回滚机制

## 📈 性能优化建议

### 1. Gas优化
- 减少存储操作
- 使用事件替代存储
- 批量操作
- 优化循环

### 2. 调用优化
- 减少外部调用
- 缓存常用数据
- 异步处理
- 并行操作

### 3. 存储优化
- 使用packed结构
- 避免冗余存储
- 定期清理
- 压缩数据

这个详细的流程图和架构说明展示了4个核心合约之间的复杂关系，以及它们如何协同工作来实现完整的跨链功能。
